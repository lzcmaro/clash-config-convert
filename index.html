<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Clash 懒人配置生成器</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;max-width:800px;margin:40px auto;padding:0 16px;}
  label{display:block;font-size:15px;margin-top:14px;}
  input[type="text"], input[type="url"]{width:100%;padding:8px 10px;font-size:15px;box-sizing:border-box;border: 1px solid #ccc; border-radius: 4px;}
  button{margin-top:18px;padding:8px 14px;font-size:15px;cursor:pointer;background-color: #007bff; color: white; border: none; border-radius: 4px; margin-right: 10px;}
  button:hover { background-color: #0056b3; }
  pre{background:#f5f5f5;padding:12px;border-radius:6px;margin-top:20px;white-space:pre-wrap;word-break:break-word;max-height:500px;overflow:auto;}
  
  fieldset { border: 1px solid #ddd; border-radius: 6px; padding: 10px 16px 16px; margin-top: 20px; }
  legend { font-size: 16px; font-weight: 600; padding: 0 6px; }
  .group-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
  .group-grid label { display: flex; align-items: center; margin-top: 0; font-size: 14px; }
  .group-grid input { margin-right: 6px; }
</style>
</head>
<body>

<h2>Clash 懒人配置</h2>
<h5>最后更新： 2025/11/15</h5>

<label for="subName">订阅名称</label>
<input id="subName" type="text" placeholder="例如：订阅一 / MySub"/>

<label for="subUrl">订阅链接</label>
<input id="subUrl" type="url" placeholder="https://xxx.yyyy/your/sub"/>

<fieldset>
  <legend>选择策略组</legend>
  <div class="group-grid" id="proxyGroupCheckboxes"></div>
</fieldset>

<button id="btnGenerate">生成并下载 YAML</button>
<button id="btnPreview">仅预览</button>

<pre id="result">结果会显示在这里</pre>

<script>
const TEMPLATE_FILE = "template.yaml"; 

// 策略组数据数组：用于动态生成复选框
const OPTIONAL_GROUPS = [
  { name: "YouTube", checked: true },
  { name: "Netflix", checked: true },
  { name: "Telegram", checked: true },
  { name: "TikTok", checked: true },
  { name: "Disney", checked: false },
  { name: "Steam", checked: false },
  { name: "PayPal", checked: false },
  { name: "OpenAI", checked: true },
  { name: "Github", checked: false },
  { name: "Google", checked: true },
  { name: "Microsoft", checked: true }, 
  { name: "Apple", checked: false },
  { name: "Binance", checked: false },
  
  // 如果未来你想增加新的分组，只需要在这里添加一行即可，例如：
  // { name: "BiliBili", checked: false },
];

/**
 * 动态渲染策略组复选框
 */
function renderGroupCheckboxes() {
  const container = document.getElementById("proxyGroupCheckboxes");
  if (!container) return;

  container.innerHTML = OPTIONAL_GROUPS.map(group => `
    <label>
      <input type="checkbox" value="${group.name}" ${group.checked ? 'checked' : ''}> 
      ${group.name}
    </label>
  `).join('');
}

// 页面加载完成后立即执行渲染
document.addEventListener('DOMContentLoaded', renderGroupCheckboxes);

async function loadTemplate() {
  const res = await fetch(TEMPLATE_FILE + '?_=' + Date.now()); // 加时间戳防止缓存
  if (!res.ok) throw new Error("读取 " + TEMPLATE_FILE + " 失败");
  return res.text();
}

// 原始的简单替换函数
function replaceTemplate(template, name, url) {
  return template
    .split("{{SUB_NAME}}").join(name)
    .split("{{SUB_URL}}").join(url);
}

async function generate(download = false) {
  const name = document.getElementById("subName").value.trim();
  const url = document.getElementById("subUrl").value.trim();
  const resultEl = document.getElementById("result");

  if (!name || !url) {
    alert("请填写订阅名称与订阅链接");
    return;
  }

  // 1. 获取所有未被勾选的策略组
  const groupsToRemove = [];
  document.querySelectorAll("#proxyGroupCheckboxes input[type='checkbox']").forEach(el => {
    if (!el.checked) {
      groupsToRemove.push(el.value);
    }
  });
  
  try {
    // 2. 加载模板
    let templateString = await loadTemplate();
    
    // 3. 替换订阅占位符
    let finalYaml = replaceTemplate(templateString, name, url);

    // 4. 遍历所有要移除的组，使用正则表达式“删除”相关文本块
    groupsToRemove.forEach(groupName => {
      // 4.1. 构建正则表达式来删除 `proxy-groups` 中的条目
      // 匹配从 `- name: GroupName` 开始，直到下一个 `- name:` 或 `rules:` 之前的所有内容
      // [\\s\\S]*? 是非贪婪匹配，包括换行符
      // (?= ... ) 是正向先行断言，确保我们只匹配到下一个组的开头，而不包括它
      const groupRegex = new RegExp(`\\n\\s*-\\s*name:\\s*${groupName}[\\s\\S]*?(?=\\n\\s*-\\s*name:|\\n\\s*rules:)`, 'g');
      finalYaml = finalYaml.replace(groupRegex, '');

      // 4.2. 构建正则表达式来删除 `rules` 中的条目
      // 匹配所有以 `,GroupName` 结尾的规则行 (包括可能的,no-resolve等后缀)
      const ruleRegex = new RegExp(`\\n {2}-\\s*(')?.*,\\s*${groupName}.*`, 'g');
      finalYaml = finalYaml.replace(ruleRegex, '');
    });
    
    // 5. 显示最终的、保留了格式的 YAML 字符串
    resultEl.textContent = finalYaml;

    // 6. 处理下载
    if (download) {
      const blob = new Blob([finalYaml], { type: "text/yaml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "config.yaml";
      a.click();
      URL.revokeObjectURL(a.href);
    }

  } catch (e) {
    alert("生成失败：" + e.message);
    console.error(e);
  }
}

document.getElementById("btnGenerate").addEventListener("click", () => generate(true));
document.getElementById("btnPreview").addEventListener("click", () => generate(false));

// 输入框按 Enter 直接生成
document.querySelectorAll("input").forEach(el => {
  el.addEventListener("keydown", e => {
    if (e.key === "Enter") generate(true);
  });
});
</script>

</body>
</html>
